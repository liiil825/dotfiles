#!/usr/bin/env sh

fetch() {
  PUBLIC_KEY="PA0IIgu3utmogBria"
  LOCATION=$1
  [ -z $LOCATION ] && LOCATION="wuhan"
  TS=$(date +%s)
  PARMS="location=$LOCATION&public_key=$PUBLIC_KEY&ts=$TS&ttl=300"
  sign=$(echo -n "$PARMS" | openssl dgst -sha1 -hmac "$SENIVERSE_PRIVATE_KEY" -binary | openssl base64)
  API_URL="https://api.seniverse.com/v3/weather/now.json"

  data=$(curl "$API_URL?$PARMS&sig=$sign")
  # data='{"results":[{"location":{"id":"WT3Q0FW9ZJ3Q","name":"æ­¦æ±‰","country":"CN","path":"æ­¦æ±‰,æ­¦æ±‰,æ¹–åŒ—,ä¸­å›½","timezone":"Asia/Shanghai","timezone_offset":"+08:00"},"now":{"text":"å¤šäº‘","code":"4","temperature":"27"},"last_update":"2023-06-08T19:50:15+08:00"}]}'
  echo "$data"
}

weather_code="null"
while [[ true ]]; do
  if [[ $weather_code == "null" ]]; then
    data=$(fetch $1)
    weather_code=$(echo "$data" | jq -r '.results[0].now.code')
  else
    break
  fi
  sleep .1
done

temperature=$(echo "$data" | jq -r '.results[0].now.temperature')
weather_icon=""
case "$weather_code" in
0 | 1 | 2 | 3)
  weather_icon="ğŸŒˆ"
  ;;
4)
  weather_icon="ğŸŒ¤"
  ;;
5 | 6)
  weather_icon="ğŸŒ¤"
  ;;
7 | 8)
  weather_icon="â˜ï¸"
  ;;
9)
  weather_icon="â˜ï¸"
  ;;
10)
  # 10 é˜µé›¨ Shower
  weather_icon="â›ˆï¸"
  ;;
11)
  # 11 é›·é˜µé›¨ Thundershower
  weather_icon="â›ˆï¸"
  ;;
12)
  # 12 é›·é˜µé›¨ä¼´æœ‰å†°é›¹ Thundershower with Hail
  weather_icon="ğŸŒ¨ï¸"
  ;;
13 | 14 | 15 | 16 | 17 | 18)
  # 13 å°é›¨ Light Rain
  # 14 ä¸­é›¨ Moderate Rain
  # 15 å¤§é›¨ Heavy Rain
  # 16 æš´é›¨ Storm
  # 17 å¤§æš´é›¨ Heavy Storm
  # 18 ç‰¹å¤§æš´é›¨ Severe Storm
  weather_icon="ğŸŒ§"
  ;;
19 | 20)
  # 19 å†»é›¨ Ice Rain
  # 20 é›¨å¤¹é›ª Sleet
  weather_icon="ğŸŒ§ï¸"
  ;;
*)
  # 21 é˜µé›ª Snow Flurry
  # 22 å°é›ª Light Snow
  # 23 ä¸­é›ª Moderate Snow
  # 24 å¤§é›ª Heavy Snow
  # 25 æš´é›ª Snowstorm
  # 26 æµ®å°˜ Dust
  # 27 æ‰¬æ²™ Sand
  # 28 æ²™å°˜æš´ Duststorm
  # 29 å¼ºæ²™å°˜æš´ Sandstorm
  # 30 é›¾ Foggy
  # 31 éœ¾ Haze
  # 32 é£ Windy
  # 33 å¤§é£ Blustery
  # 34 é£“é£ Hurricane
  # 35 çƒ­å¸¦é£æš´ Tropical Storm
  # 36 é¾™å·é£ Tornado
  # 37 å†· Cold
  # 38 çƒ­ Hot
  weather_icon="â“"
  ;;
esac

TEXT="$weather_icon  $temperature"
DATA=$(python3 ~/.config/waybar/scripts/weather.py)
tooltip=$(echo $DATA | jq -c ".tooltip")
echo "{\"text\": \"$TEXT\", \"tooltip\": $tooltip}"
