#!/usr/bin/env bash

fetch() {
  PUBLIC_KEY="76745a0f1a3b63b9944440765e36ca00"
  URL="https://restapi.amap.com/v3/weather/weatherInfo"
  LOCATION=$1
  [[ -z $LOCATION ]] && LOCATION="420104"
  TS=$(date +%s)
  PARMS="city=$LOCATION&key=$PUBLIC_KEY"

  data=$(curl "$URL?$PARMS")
  # {"status":"1","count":"1","info":"OK","infocode":"10000","lives":[{"province":"æ¹–åŒ—","city":"ç¡šå£åŒº","adcode":"420104","weather":"æ™´","temperature":"30","winddirection":"ä¸œå—","windpower":"â‰¤3","humidity":"70","reporttime":"2023-06-20 11:02:24","temperature_float":"30.0","humidity_float":"70.0"}]}
  echo "$data"
}

# weather="null"
# while [[ true ]]; do
#   if [[ $weather == "null" ]]; then
#     data=$(fetch $1)
#     weather=$(echo "$data" | jq -r '.lives[0].weather')
#   else
#     break
#   fi
#   sleep .1
# done

data=$(fetch $1)
weather=$(echo "$data" | jq -r '.lives[0].weather')
temperature=$(echo "$data" | jq -r '.lives[0].temperature')
# weather=$(echo "$data" | jq -r '.lives[0].weather')
weather_icon=""
case "$weather" in
"æ™´")
  weather_icon="ğŸŒˆ"
  ;;
"å°‘äº‘")
  weather_icon="ğŸŒ¤"
  ;;
"å¤šäº‘")
  weather_icon="â˜ï¸"
  ;;
"æ™´é—´å¤šäº‘")
  weather_icon="ğŸŒ¥"
  ;;
"é˜µé›¨")
  # 10 é˜µé›¨ Shower
  weather_icon="â›ˆï¸"
  ;;
"é›·é˜µé›¨")
  # 11 é›·é˜µé›¨ Thundershower
  weather_icon="â›ˆï¸"
  ;;
"é›·é˜µé›¨å¹¶ä¼´æœ‰å†°é›¹")
  # 12 é›·é˜µé›¨ä¼´æœ‰å†°é›¹ Thundershower with Hail
  weather_icon="ğŸŒ¨ï¸"
  ;;
*)
  weather_icon="â“ $weather"
  ;;
esac

TEXT="$weather_icon  $temperature"
DATA=$(python3 ~/.config/waybar/scripts/weather.py)
tooltip=$(echo $DATA | jq -c ".tooltip")
echo "{\"text\": \"$TEXT\", \"tooltip\": $tooltip}"
